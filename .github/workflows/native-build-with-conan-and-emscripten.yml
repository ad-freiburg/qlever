name: "Native build to WebAssembly using Conan and Emscripten"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    strategy:
      fail-fast: false
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    - name: Install conan package manager
      run: |
        sudo apt-get install pipx
        pipx ensurepath
        source ~/.bashrc
        pipx install conan
      shell: bash

    - name: Install curl, npm, nvm and nodejs
      run: |
        sudo apt install curl npm
        source ~/.bashrc
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
        \. "$HOME/.nvm/nvm.sh"
        nvm install 25
        source ~/.bashrc
        node -v
      shell: bash

    - name: Get build and host profiles for conan
      working-directory: ${{github.workspace}}
      run: |
        conan profile detect

    - name: Cache for conan
      uses: actions/cache@v3
      env:
        cache-name: cache-conan-with-emscripten-modules-ubuntu-24.04
      with:
        path: ~/.conan2
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('conanfile.txt', 'conanprofiles/emscripten.profile')}}

    - name: Install and run conan. Also create a build directory.
      working-directory:  ${{github.workspace}}
      run: conan install . -pr:b default -pr:h conanprofiles/emscripten.profile -s build_type=Release -b missing -of build

    - name: Configure CMake
      working-directory: ${{github.workspace}}/build
      run: cmake -S .. -B . -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DLOGLEVEL=INFO -DUSE_PARALLEL=true -D_NO_TIMING_TESTS=ON -D_EMSCRIPTEN_NO_INDEXBUILDER_AND_SERVER=ON -D_NO_BENCHMARK=ON -D_DISABLE_EMSCRIPTEN_PROBLEMATIC_TESTS=ON -GNinja

    - name: Build
      working-directory: ${{github.workspace}}/build
      run: cmake --build .

    - name: Test
      working-directory: ${{github.workspace}}/build/test
      run: >
        source ../conanrun.sh;
        env CTEST_OUTPUT_ON_FAILURE=1 ctest -C Release .;

    - name: Running and printing the benchmark examples.
      working-directory: ${{github.workspace}}/build
      run: >
        source ./conanrun.sh;
        benchmark/BenchmarkExamples -p;

      # explicitly specify the binary directory for the E2E script via the `-d` option to also
      # test that it works.
    - name: E2E
      run: >
        source ${{github.workspace}}/build/conanrun.sh;
        ${{github.workspace}}/e2e/e2e.sh -d build










